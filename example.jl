## Demo for TikhonovFenichelReductions.jl 
#
# This example is based on:
# N. Kruff, C. Lax, V. Liebscher, and S. Walcher, ‚ÄòThe Rosenzweig‚ÄìMacArthur
# system via reduction of an individual based model‚Äô, J. Math. Biol., vol. 78,
# no. 1‚Äì2, pp. 413‚Äì439, Jan. 2019, doi: 10.1007/s00285-018-1278-y.

## Load packages

using Oscar # optional (results in prettier printing and loads Oscar functions to Main namespace)
using TikhonovFenichelReductions

## Define system

# dynamic variables
x = ["B", "S", "H"]

# parameters
Œ∏ = ["Œ±", "Œ≤", "Œ≥", "Œ¥", "Œ∑", "œÅ"]

# RHS of ODE system xÃá = f(x, Œ∏)
function f(x, Œ∏)
  B, S, H = x
  Œ±, Œ≤, Œ≥, Œ¥, Œ∑, œÅ = Œ∏
  return [
    œÅ*B*(1-B) - Œ±*B*H,
    -Œ∑*S + Œ≥*B*H,
    Œ≤*S- Œ¥*H + Œ∑*S - Œ≥*B*H
  ]
end

# dimension of the reduced system
s = 2

# create Problem
problem = ReductionProblem(f, x, Œ∏, s);

# find slow-fast separations that are TFPVs
idx, V, dim_V = tfpv_candidates(problem);

# find all general TFPVs using necessary conditions on the determinants of D‚ÇÅf
# G is a Gr√∂bner basis for this, such that every TFPV of dimension s lies in ùëâ(G)
G = tfpv_groebner_basis(problem)

# Typically, the computation of the Gr√∂bner basis in tfpv_groebner_basis is
# much slower than the computation for slow-fast fast separations in
# tfpv_candidates, which only computes the irreducible components of ùëâ(f(‚ãÖ,œÄ))
# and their dimension via a minimal primary computation and the Krull
# dimensions for the corresponding ideals. However, there might exist TFPVs
# which are not slow-fast separations. Here, this is not the case, because G is
# a monomial ideal.

# slow-fast separations:
print_tfpv(problem, idx)
# all TFPVs lie in one of the irreducible components generated by these ideals:
primary_decomposition(ideal(G))

## Make variables and parameters available in Main namespace

B, S, H = problem.x;
Œ±, Œ≤, Œ≥, Œ¥, Œ∑, œÅ = problem.Œ∏;

## Compute a reduced system
# The Rosenzweig-MaxArthur system corresponds to the TFPV candidate œÄ‚ÇÅ‚ÇÜ (See section 3.3 in the paper).

# instantiate reduction 
reduction = Reduction(problem, idx[15]);

# look at the variety that contains the slow manifold
V[15] # ‚üπ M‚ÇÄ = {(B,S,0) | B,S ‚àà ‚Ñù}
dim_V[15] # has Krull dimension 2 (i.e. the topological dimension of M‚ÇÄ in ‚ÑÇ[B,S,H], but also in ‚Ñù[B,S,H] if there exists a non-singular point)
set_manifold!(reduction, [B, S, 0])

# define product decomposion f‚Å∞ = P‚ãÖœà (can be done via specifying œà with V(œà) = V(f‚Å∞) in this case)
set_decomposition!(reduction, [H])

# compute the reduced system
g_raw, g = compute_reduction(reduction);
display(g)

# check if g as the RHS of the reduced system is the same as in the paper 
dBdt = œÅ*B*(1-B) - Œ±*(Œ∑ + Œ≤)*B*S//(Œ¥ + Œ≥*B)
dSdt = -Œ∑*S + Œ≥*(Œ∑ + Œ≤)*B*S//(Œ¥ + Œ≥*B)
all(iszero.(g[1:2] .- [dBdt, dSdt])) 

# slow manifold is attractive if all non-zero eigenvalues of Df at x‚ÇÄ have negative real part
reduction.Df_x‚ÇÄ

