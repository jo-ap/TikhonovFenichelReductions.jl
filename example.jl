## Demo for TikhonovFenichelReductions.jl 
#
# This example is based on:
# N. Kruff, C. Lax, V. Liebscher, and S. Walcher, ‚ÄòThe Rosenzweig‚ÄìMacArthur
# system via reduction of an individual based model‚Äô, J. Math. Biol., vol. 78,
# no. 1‚Äì2, pp. 413‚Äì439, Jan. 2019, doi: 10.1007/s00285-018-1278-y.

## Load packages

using Oscar # optional (results in prettier printing and loads Oscar functions to Main namespace)
using TikhonovFenichelReductions

## Define system

# dynamic variables
x = ["B", "S", "H"]

# parameters
p = ["Œ±", "Œ≤", "Œ≥", "Œ¥", "Œ∑", "œÅ"]

# RHS of ODE system xÃá = f(x, p)
function f(x, p)
  B, S, H = x
  Œ±, Œ≤, Œ≥, Œ¥, Œ∑, œÅ = p
  return [
    œÅ*B*(1-B) - Œ±*B*H,
    -Œ∑*S + Œ≥*B*H,
    Œ≤*S- Œ¥*H + Œ∑*S - Œ≥*B*H
  ]
end

# dimension of the reduced system
s = 2

# create Problem
problem = ReductionProblem(f, x, p, s)

# find slow-fast separations that are TFPVs
sf_separations, V, dim_V = tfpv_candidates(problem);

# find all general TFPVs using necessary conditions on the determinants of D‚ÇÅf
# G is a Gr√∂bner basis for this, such that every TFPV of dimension s lies in ùëâ(G)
G = tfpv_groebner_basis(problem)

# Typically, the computation of the Gr√∂bner basis in tfpv_groebner_basis is
# much slower than the computation for slow-fast fast separations in
# tfpv_candidates, which only computes the irreducible components of ùëâ(f(‚ãÖ,p_sf))
# and their dimension via a minimal primary computation and the Krull
# dimensions for the corresponding ideals. However, there might exist TFPVs
# which are not slow-fast separations. Here, this is not the case, because G is
# a monomial ideal.

# slow-fast separations:
print_tfpv(problem, sf_separations)

# all TFPVs lie in one of the irreducible components generated by these ideals:
primary_decomposition(ideal(G))

## Make variables and parameters available in Main namespace

B, S, H = system_components(problem)
Œ±, Œ≤, Œ≥, Œ¥, Œ∑, œÅ = system_parameters(problem)

## Compute a reduced system

print_results(problem, sf_separations, V, dim_V)

# The Rosenzweig-MaxArthur system corresponds to the TFPV candidate 15 (See section 3.3 in the paper).
# instantiate reduction 
reduction = Reduction(problem, sf_separations[15])

# look at the variety that contains the slow manifold
V[15] # => M‚ÇÄ = {(B,S,0) | B,S ‚àà ‚Ñù}
dim_V[15] # has dimension 2 
set_manifold!(reduction, [B, S, 0])

# define product decomposion f0 = P‚ãÖPsi (can be done via specifying Psi with V(Psi) = V(f‚Å∞) in this case)
set_decomposition!(reduction, [H])

# compute the reduced system
g_raw, g = compute_reduction(reduction);
display(g)

# check if g as the RHS of the reduced system is the same as in the paper 
dBdt = œÅ*B*(1-B) - Œ±*(Œ∑ + Œ≤)*B*S//(Œ¥ + Œ≥*B)
dSdt = -Œ∑*S + Œ≥*(Œ∑ + Œ≤)*B*S//(Œ¥ + Œ≥*B)
all(iszero.(g[1:2] .- [dBdt, dSdt])) 

# slow manifold is attractive if all non-zero eigenvalues of Df at x0 have negative real part
jacobian_tfpv_at_x0(reduction)

## Compute multiple reductions at once

# Get all unique slow manifolds for which reductions can exist
V_unique = unique_slow_manifolds(problem, V, dim_V)

# Get all indices for TFPVs with a reduction onto ùëâ(H)
idx_similar = similar_reductions(V, V_unique[4])

# compute reductions for all TFPVs that have the same manifold (we can choose the same P-Œ® decomposion for f‚Å∞)
R = compute_bulk_reductions(problem, sf_separations, idx_similar, [H], [B,S,0]; idx_components=[1,2]);

# Access the `Reduction` object and reduced system with the indices as in `idx_similar`
reduction_3 = R[3][1]
g_3 = R[3][2]


